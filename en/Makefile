# This makefile requires GNU make.

hg_id := $(shell hg id 2>/dev/null | sed -e 's/ tip\>//' -e 's/ /,/g' || echo external)

sources := \
	00book.tex \
	99book.bib \
	99defs.tex \
	intro.tex \
	mq.tex \
	build_id.tex

image-sources := \
	mq-stack.svg

example-sources := \
	examples/run-example \
	examples/mq.qinit-help \
	examples/mq.tutorial

latex-options = \
	-interaction batchmode \
	-output-directory $(dir $(1)) \
	-jobname $(basename $(notdir $(1)))

all: pdf html

pdf: pdf/hgbook.pdf

define pdf
	mkdir -p $(dir $@)
	pdflatex $(call latex-options,$@) $< || (rm -f $@; exit 1)
	cp 99book.bib $(dir $@)
	cd $(dir $@) && bibtex $(basename $(notdir $@))
	cd $(dir $@) && makeindex $(basename $(notdir $@))
	pdflatex $(call latex-options,$@) $< || (rm -f $@; exit 1)
	pdflatex $(call latex-options,$@) $< || (rm -f $@; exit 1)
endef

pdf/hgbook.pdf: $(sources) $(image-sources:%.svg=%_pdf.png) examples
	$(call pdf)

html: html/onepage/hgbook.html html/split/hgbook.html

# This is a horrible hack to work around the fact that the htlatex
# command in tex4ht is itself a horrible hack.  I really don't want to
# include verbatim the big wad of TeX that is repeated in that script,
# so instead I mangle the script itself.

define htlatex
	mkdir -p $(dir $(1))
	head -2 $(shell which htlatex) > $(dir $(1))/htlatex.book
	cp 99book.bib $(dir $@)
	echo '(cd $(dir $@) && bibtex $(basename $(notdir $@)))' >> $(dir $(1))/htlatex.book
	echo '(cd $(dir $@) && makeindex $(basename $(notdir $@)))' >> $(dir $(1))/htlatex.book
	head -3 $(shell which htlatex) >> $(dir $(1))/htlatex.book
	echo 'echo status $$$$' >>  $(dir $(1))/htlatex.book
	chmod 755 $(dir $(1))/htlatex.book
	$(dir $(1))/htlatex.book $(2) "xhtml,html4-uni,$(3)" " -cunihtf -utf8" "" "$(call latex-options,$(1))" || (rm -f $(1); exit 1)
	cd $(dir $(1)) && tex4ht -f/$(basename $(notdir $(1))) -cvalidate -cunihtf
	cd $(dir $(1)) && t4ht -f/$(basename $(notdir $(1)))
	perl -pi -e 's/&#x00([0-7][0-9a-f]);/chr(hex($$1))/egi' $(dir $(1))/*.html
endef

html/onepage/hgbook.html: $(sources) $(image-sources:%.svg=%.png) examples
	$(call htlatex,$@,$<)
	cp $(image-sources:%.svg=%.png) $(dir $@)

html/split/hgbook.html: $(sources) $(image-sources:%.svg=%.png) examples
	$(call htlatex,$@,$<,2)
	cp $(image-sources:%.svg=%.png) $(dir $@)

beta: beta/pdf/hgbook.pdf beta/html/onepage/hgbook.html beta/html/split/hgbook.html

beta/%.tex: %.tex
	./fblinks $(hg_id) $(dir $@) $<

beta/pdf/hgbook.pdf: $(sources:%.tex=beta/%.tex) $(image-sources:%.svg=%_pdf.png) examples fblinks
	$(call pdf)

beta/html/onepage/hgbook.html: $(sources:%.tex=beta/%.tex) $(image-sources:%.svg=%.png) examples
	$(call htlatex,$@,$<)
	cp $(image-sources:%.svg=%.png) $(dir $@)

beta/html/split/hgbook.html: $(sources:%.tex=beta/%.tex) $(image-sources:%.svg=%.png) examples
	$(call htlatex,$@,$<,2)
	cp $(image-sources:%.svg=%.png) $(dir $@)

# Produce 90dpi PNGs for the web.

%.png: %.svg
	inkscape -D -e $@ $<

# Produce 300dpi PNGs for PDF.

%_pdf.png: %.svg
	inkscape -D -d 300 -e $@ $<

examples: examples/.run

examples/.run: $(example-sources)
	cd examples && ./run-example

build_id.tex: $(wildcard ../.hg/00changelog.[id])
	echo $(hg_id) > build_id.tex

clean:
	rm -rf beta html pdf *.eps *.png *.aux *.dvi *.log *.out \
		examples/*.out examples/.run build_id.tex
